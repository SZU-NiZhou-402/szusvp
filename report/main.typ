#set heading(numbering: (..num) => if num.pos().len() < 5 {
  numbering("1.1", ..num)
})

#let hrule(length: 100%, stroke: gray + 1pt) = {
  line(length: length, stroke: stroke)
}

#let imageonside(lefttext, rightimage, bottomtext: none, marginleft: 0em, margintop: 0.5em) = {
  set par(justify: true)
  grid(columns: 2, column-gutter: 1em, lefttext, rightimage)
  set par(justify: false)
  block(inset: (left: marginleft, top: -margintop), bottomtext)
}

#set text(font: ("Sarasa Term SC Nerd"))

#set table(
  fill: (x, y) =>
    if x == 0 or y == 0 { rgb("#917f7f") },
  inset: (right: 1.5em),
)

#show table.cell: it => {
  if it.x == 0 or it.y == 0 {
    set text(white)
    strong(it)
  } else {
    it
  }
}

#counter(heading).update(5)

= 硬件技术
#hrule()
本章节详细介绍了“基于云边端大模型语音交互助手”项目的硬件构成，围绕核心开发板“ESP32-S3 PICO”展开，分析了其主体架构、关键芯片选型以及相关的外围硬件模块。

== 主体架构
#hrule()
嵌入式系统的主体架构多种多样，常见的有
- 基于微控制器 (MCU) 的架构：例如STM32系列、AVR系列、ESP32系列等。这类架构通常集成度高，片上包含CPU核心、Flash、RAM以及丰富的外设接口（GPIO, SPI, I2C, UART, ADC/DAC等）。功耗较低，成本效益好，适合于控制密集型、实时性要求高的应用。
- 基于微处理器 (MPU) + 外部存储的架构：例如ARM Cortex-A系列（如树莓派使用的博通BCM系列芯片）。这类架构通常性能更强，可以运行完整的操作系统（如Linux），拥有更大的内存和存储空间。适合于计算密集型、需要复杂应用和网络服务的场景。功耗和成本相对较高。
- 基于FPGA的架构：现场可编程门阵列，硬件逻辑可定制，并行处理能力强，灵活性高。适用于特定算法加速、高速接口等场景，开发难度和成本较高。
- 专用集成电路 (ASIC)：为特定功能定制的芯片，性能和功耗最优，但研发周期长，初始成本极高，不具备灵活性。
#hrule()
我们的需求
- 即使经过蒸馏和剪枝，想要运行LLM依旧需要非常强大的cpu算力，同时，为了开发板其他任务不被拖慢，我们最好能够选择有多个核心的soc
- 大多数开发板有内置的flash以存储程序，但是要存储LLM模型显然不足，因此最好选择有外接大容量flash芯片的开发板
- 为了灵活期间，最好还有常见的无线功能(wifi/蓝牙/红外)等
- 为了方便使用，最好能够有良好的软件生态和丰富的外设接口
#hrule()
最后综合考虑成本，算力和灵活性，我们选择ESP32-S3 PICO开发板。\
本项目采用的 ESP32-S3 PICO 开发板 属于典型的基于MCU的架构。其核心是乐鑫（Espressif）的ESP32-S3系列芯片。 该开发板的架构特点如下：

#imageonside([
  \
  - 高度集成：主控芯片ESP32-S3集成了处理器核心、Wi-Fi和蓝牙模块、PSRAM（部分型号）、以及多种外设控制器。ESP32-S3 PICO板在此基础上进一步集成了USB转串口、Flash存储、晶体振荡器、天线以及必要的电源管理电路，形成了小巧而功能完整的系统。
  \
  - 低功耗设计：ESP32-S3芯片本身支持多种低功耗模式，配合RTOS可以实现高效的电源管理，适合电池供电或对功耗有要求的边缘设备。
], figure(
  image("image/esp32-pico.png", width: 90%),
  caption: "ESP32-S3-Pico开发板",
), bottomtext: [
  - 接口丰富：引出了大部分ESP32-S3的可用GPIO，支持SPI、I2C、UART、I2S、ADC等，方便连接各类传感器（如麦克风）、执行器（如功放和扬声器）和显示设备。
  - 特定优化：ESP32-S3芯片包含用于加速神经网络计算的向量指令，这对于在端侧运行蒸馏剪枝后的小型LLM模型具有重要意义，使其能够在资源受限的设备上实现更快的响应。
  - 紧凑尺寸：PICO板型设计紧凑，便于集成到小型化产品原型中
])

该架构非常适合本项目的需求：通过I2S接口连接收音和功放芯片进行语音数据的采集和播放，利用ESP32-S3的计算能力运行本地LLM进行初步指令识别和响应，并通过Wi-Fi/蓝牙与云端或边缘计算节点通信，实现更复杂的语音交互功能。

== 主控芯片
#hrule()
主控芯片是整个硬件系统的核心，负责运行程序、处理数据、控制外设。常见的选型有：
- STM32系列(STMicroelectronics)\ 
  基于ARM Cortex-M内核，产品线非常广泛，从低功耗M0到高性能M7，外设丰富，生态成熟，是工业控制和消费电子领域的常用选择。
- nRF系列 (Nordic Semiconductor)\
  主打低功耗蓝牙 (BLE)，其SoC集成了ARM Cortex-M内核和高质量的无线射频单元，广泛用于可穿戴设备、物联网终端。
- ESP32系列 (Espressif Systems)\
  基于Tensilica Xtensa LX系列内核，以高性价比的Wi-Fi和蓝牙连接功能著称，近年来在AIoT领域发展迅速，推出了支持AI加速指令的S3、C3等系列。
- 树莓派RP2040 (Raspberry Pi Foundation)\
  双核ARM Cortex-M0+，独特的PIO（可编程I/O）是其特色，性价比高，社区活跃。
#hrule()
本项目选用的是 ESP32-S3R8 芯片，具体说明如下：
- 核心与性能
  - 采用双核 32 位 Xtensa® LX7 微处理器，主频高达 240 MHz。
  - 内置 512 KB SRAM，本项目选用的ESP32-S3 PICO板上额外通过SPI接口连接了 8MB PSRAM (Pseudo Static RAM)，为运行LLM模型提供了必要的内存空间。
  - 支持 AI 加速向量指令，可显著提升神经网络运算、信号处理等性能，对于在端侧运行LLM模型至关重要。
- 无线通信
  - 集成 2.4 GHz Wi-Fi (802.11 b/g/n)，支持 Station 模式、SoftAP 模式、SoftAP + Station 模式和混杂模式。
  - 集成 Bluetooth® 5 (LE)，支持低功耗蓝牙，包括高功率模式 (20 dBm) 和长距离支持 (Coded PHY)。
- 存储
  - 支持高达 1GB 的 Quad SPI Flash 和 PSRAM。本开发板板载 16MB Quad SPI Flash
- 外设接口
  - 多达 45 个可编程 GPIO。
  - 丰富的标准接口：SPI (4个), LCD接口, Camera接口, UART (3个), I2C (2个), I2S (2个), RMT (8通道), ADC (2个, 12位, 多达20通道), DAC (2个, 8位), USB OTG 1.1 等
  - 其中 I2S 接口 对于本项目的语音输入（连接数字麦克风或CODEC）和输出（连接数字功放）至关重要。
- 安全性：支持安全启动、Flash 加密、 cryptographic hardware acceleration (AES, SHA, RSA, ECC)。
- 低功耗管理：支持多种睡眠模式，可显著降低系统功耗。
\
ESP32-S3R8凭借其强大的双核处理器、AI加速能力、充足的RAM（SRAM+PSRAM）、集成的无线连接以及丰富的接口，为在端侧运行轻量级LLM并实现语音交互功能提供了坚实的硬件基础。
== 收音芯片
#hrule()
收音芯片，通常指麦克风及其相关的信号调理电路。常见的麦克风类型有驻极体电容麦克风 (ECM) 和MEMS麦克风。

#table(
  columns: 3,
  [特性], [普通电容麦克风(ECM)], [MEMS麦克风],

  [接收人声能力],   [频响范围尚可，但一致性较差，易受环境温湿度影响。], [频响平坦，一致性好，对人声细节捕捉更准确，音质更清晰稳定。],

  [近场、远场参数], [一般用于近场拾音，远场性能受限于尺寸和灵敏度一致性。], [体积小巧，易于组成麦克风阵列以实现远场拾音和波束成形。单个MEMS麦克风也常用于近场，但其性能稳定性更好。本项目的ESP32S3 PICO板载的MSM261S4030H0R为全向型，适合近中场语音采集。],

  [信噪比 (SNR)],  [一般在50-60dB，性能参差不齐。], [通常较高，可达60dB以上，高端产品可达70dB以上，提供更纯净的音频信号。例如MSM261S4030H0R的典型SNR为65dB。],

  [功耗],         [通常在几百微安级别。], [通常较低，几十到几百微安级别，例如MSM261S4030H0R在标准模式下功耗约85µA。],
  
  [其他],         [价格低廉，工艺成熟，但体积较大，不耐回流焊。], [体积小，可SMT贴片，耐高温，抗振动和射频干扰能力强。],
)
本项目中，ESP32-S3 PICO开发板板载了 MSM261S4030H0R MEMS麦克风。这是一款I2S接口的数字MEMS麦克风，具有高信噪比（典型值65dB）、低功耗的特点，非常适合用于语音识别等对音质有一定要求的嵌入式应用。其数字I2S输出可以直接连接到ESP32-S3的I2S外设，简化了硬件设计并减少了模拟信号干扰。

== 功放芯片
#hrule()
功放芯片（Power Amplifier）用于放大来自主控芯片或CODEC的音频信号，以驱动扬声器发声。
功放类别简介：
- A类 (Class A)：最佳线性度，音质最好，但效率极低（通常\<25%），发热大，不适合便携设备。
- B类 (Class B)：效率较高（理论可达78.5%），但存在交越失真。
- AB类 (Class AB)：A类和B类的折中，音质较好，效率也较高（通常50%-70%），是传统模拟功放的主流。
- C类 (Class C)：效率高，但失真极大，主要用于射频放大。
- D类 (Class D)：开关式功放，效率非常高（通常>85%或90%），发热小，体积小。通过PWM或PDM调制将模拟或数字音频信号转换为高频开关信号驱动扬声器。音质通过精心设计可以做得很好，是目前嵌入式和便携式设备的主流选择。

功放芯片对比与选型：
+ 早期/简单模拟功放 (如 LM386)：
  - LM386是一款非常经典的低功耗音频功率放大器，模拟输入，AB类工作。
  - 优势：电路简单，外围元件少，成本低。
  - 劣势：输出功率较小（几百毫瓦），效率不高，信噪比和失真表现一般，模拟输入易受干扰。
  - 功耗：静态电流几mA，输出功率数百mW时，效率约50%-70%。
+ (过渡或特定应用，如MAX9814 - 注意：MAX9814是麦克风放大器，非功率放大器。此处替换为通用D类前身概念) 在向更高级的D类功放发展过程中，许多AB类功放芯片也在不断提升集成度和性能，但D类因其效率优势逐渐成为主流。
+ 现代数字D类功放 (如 MAX98357AEWL+T)：
  - MAX98357A是一款数字输入的D类功率放大器，通常采用I2S接口。
  - 优势：
    - 数字输入 (I2S)：直接接收来自MCU（如ESP32-S3）的数字音频流，无需DAC转换，减少了模拟链路的噪声和失真。
    - 高效率：典型的D类效率（可达90%以上），发热小，非常适合电池供电设备。
    - 无需输出滤波 (Filterless)：部分D类功放（包括MAX98357A的某些模式）可以直接驱动扬声器而无需庞大的LC输出滤波器，节省空间和成本。
    - 集成度高：内置增益控制、短路保护、热保护等功能。
    - 音质良好：现代D类功放通过先进的调制和反馈技术，音质已能满足多数消费类应用。
  - 功耗：静态电流极低（如MAX98357A在关断模式下仅几µA，静态时几mA），输出功率可达几瓦，效率高使得大部分能量转换为声音输出。

== 闪存芯片
#hrule()
闪存芯片 (Flash Memory) 是一种非易失性存储器（断电后数据不丢失），以电可擦除可编程只读存储器 (EEPROM) 为基础发展而来。它允许在操作中被多次擦或写，主要用于存储程序代码、用户数据等。闪存按内部结构可分为NOR Flash和NAND Flash。
- NOR Flash：特点是支持芯片内执行 (XIP, Execute In Place)，读取速度较快，擦写速度较慢，容量相对较小，成本较高。常用于存储启动代码和应用程序代码。
- NAND Flash：特点是擦写速度快，容量大，成本较低，但读取速度相对慢，不支持XIP，需要复杂的ECC纠错。常用于大容量数据存储（如U盘、SSD）。
对于MCU系统，通常使用 SPI NOR Flash 来存储固件和一些用户数据。它们通过SPI（Serial Peripheral Interface）总线与主控芯片通信，接口简单，引脚少。

示例芯片及本项目选型： 市面上常见的SPI NOR Flash芯片有Winbond的W25Q系列、Macronix的MX25L系列、GigaDevice的GD25Q系列等。
- W25Q32FV (32Mbit / 4MB)：一款常见的SPI NOR Flash，容量为4MB，支持标准SPI、Dual SPI、Quad SPI模式，工作电压2.7-3.6V。
- W25Q128JV (128Mbit / 16MB)：容量为16MB，同样支持多种SPI模式，提供更高的存储空间。

本项目ESP32-S3 PICO开发板板载了 16MB 的 Quad SPI Flash。虽然具体型号未在公开资料中标明，但通常会选用如 W25Q128TVPIQ (或功能兼容的型号)。
- W25Q128TVPIQ 是Winbond推出的一款128Mbit (16MB) 的SPI NOR Flash芯片。
- 容量：128Mbit / 16MByte，足以存储ESP-IDF固件、MicroPython环境（如果使用）、用户应用程序（包括小型LLM模型参数和代码）以及一些用户数据。
- 接口：支持标准SPI、Dual SPI、Quad SPI以及QPI (Quad Peripheral Interface) 模式，最高时钟频率可达133MHz (Quad I/O模式下)，提供高速数据传输。
- 特性：采用3V供电，具有较好的擦写寿命和数据保持能力。其Quad SPI模式与ESP32-S3的高速Flash接口兼容，可以实现较快的代码加载和数据读写。
该闪存芯片为本项目提供了充足且高效的非易失性存储，确保了系统固件、AI模型及用户数据的可靠存储。

== 网络天线
#hrule()
+ 大天线 (External Antennas)：
  - 如偶极子天线 (Dipole antenna)、棒状天线、八木天线等。
  - 特点：通常尺寸较大，增益较高，方向性可控，性能较好，覆盖范围广。
  - 应用：路由器、基站、对通信距离有高要求的设备。需要通过射频连接器（如SMA、IPEX）连接到PCB。
+ 板载PCB天线 (PCB Trace Antenna)
  - 直接在PCB上蚀刻出特定形状的铜箔走线形成天线，如倒F型天线 (IFA)、曲流线天线 (Meandered Inverted-F Antenna, MIFA)。
  - 特点：成本极低（几乎为零），无需额外组件，易于集成。但性能受PCB布局、地平面大小、周围环境影响较大，设计和调试需要经验。
  - 应用：许多Wi-Fi/蓝牙模块、智能家居设备。
+ 陶瓷天线
  - 将天线结构制作成小型的SMD贴片元件，材质通常为陶瓷。
  - 特点：体积非常小巧，便于集成到紧凑型设备中，SMT工艺生产方便。性能介于PCB天线和外置大天线之间，相对PCB天线性能更稳定可预测，但成本略高。
  - 应用：智能手表、手环、小型IoT模块、本项目的ESP32-S3 PICO开发板。

本项目采用的 ESP32-S3 PICO 开发板 板载了一款 2.4GHz 陶瓷天线。 这种天线选型的主要优势是：
  - 紧凑性：陶瓷天线尺寸小，非常适合PICO这种小型化开发板。
  - 集成度：直接焊接在PCB上，简化了用户的天线设计和选配工作。
  - 性能：为2.4GHz频段（Wi-Fi和蓝牙）优化，能在小尺寸下提供可接受的无线通信性能，满足一般室内环境下的语音交互助手联网需求。

虽然其性能可能不及精心设计的外置天线或大型PCB天线，但在尺寸、成本和易用性方面取得了良好平衡，适合原型开发和小型化产品。

== 实时操作系统
#hrule()
实时操作系统（Real-Time Operating System, RTOS）是为对时间确定性有严格要求的应用设计的操作系统。ESP32系列官方的SDK (ESP-IDF) 即基于FreeRTOS。
- rtthread
- RTIC
- freertos
